|\ printer|u4. Printer SpoolingMuch of the design of the printer spooling system is dependent upon other parts of the system and existing protocols; the main effort has been to add the new facilities in such a way as to remain compatible with the existing systems.  The areas needing consideration were access control (previously, anyone could use any printer), selection of which printer to use, and management of a work queue.  The actual spooling and despooling operations are very simple, using the file handling routines already provided by the fileserver.It may be pointed out that all the existing printer server protocols have severe deficiencies in both design and implementation, and different versions of the client firmware exhibit different imperfections.  The details of these problems are not fully expanded here, but the significant point is that full control over printing has to be available through the fileserver protocols (which have very few defects) for use where the printer server protocols prove unworkable.|u4.1 Existing protocols & conceptsThe standard printer server protocol, used by BBC Micros to communicate with a simple printer server, is extremely primitive.  The client sends a packet to the server to open the connection, and the server is expected to send back a reply when it is ready.  The data to be printed is sent in packets, typically 80 bytes long, and after each data packet the client waits for the server to send a reply indicating that the data has been processed.  A single bit sequence number is associated with each packet, to resolve the problem of duplicate delivery of packets under error conditions.  The connection is closed after the receipt of the final data packet, which is identified by a flag.  The worst problem is the absence of any facility to report errors, such as the printer being busy
: the only possible response is to ignore the packets being sent, and after a while the client will time out.The other protocol for communication with the printer server is a combination of a status polling facility and a substitute for a name server.  The standard printer server will respond to a packet containing the text 'PRINT ', sent to a particular port, by returning its current status; this can be 'ready', 'busy' or 'jammed'.  The latest versions of the client firmware use this facility to give some error reporting, although it does not solve the whole problem.  The alternative use of this protocol is to locate named printer servers
: a packet containing the name of the desired printer type can be broadcast to all stations open for reception on that port, and any which recognise the name will send back their status.  This automatic printer selection is available in the latest versions of client firmware, and a command program was written to provide the same facility on the earlier versions.The file server identifies users by name and password when they log on.  This information is available to the printer server combined into this fileserver, and more usefully, the user's accounting information is available.  The fileserver has a number of accounts (currently 256), which are used both for control over the use of disc space, and to control access to files.  Each file has two account numbers associated with it
: a primary account, to which the space occupied by the file is charged, and an auxiliary account.  Ownership of either the main or the auxiliary account confers ownership of that file, with the full ability to update or delete it.  Each user may have ownership of any combination of the accounts; typically, a normal user will own one personal account and possibly one or two shared accounts, while the system manager will have ownership of all the accounts.  Directories also have account numbers; only owners may create new files in a directory, and the account numbers of any new files are initially set to those of the directory.In addition to the account number system, a user may have 'system privilege'
: this allows a privileged user to edit the accounting information, set the system time, reset other users' passwords and generally control the system.  Increased security is provided by a key-operated switch on the fileserver front panel; no operations requiring system privilege may be performed if this is locked.|a4|u4.2 Access controls & printer selectionThe fileserver has two printer ports available, and so there may be two printers connected with different characteristics.  Mechanisms must be provided for users to express a preference for one printer or the other, and for the system to decide whether that choice is permitted.There is a system privileged operation to read or write the configuration table for each printer, and a simple program was written to allow a user to display and edit this information.  Each table contains the following information
:|i5The name of the printer.A flag to indicate that the printer is connected and available.A flag to indicate that unrestricted access is permitted.An account number, for use if access is restricted.The name of a file containing a banner specification (see @|v4.4|z).|iThese controls allow the system manager to restrict use of a particular printer to the owners of a specified account.  If a spare account number is used, and that account is given no disc space, each user can be granted or denied access to the printer independently from any other privileges.  No facility is provided to control the amount of output a user may generate; while this would be desirable, it is very difficult to put a 'price' on the data stream sent to the printer.  Nothing is known about the type or character codes of the printers which may be attached, so it is not possible to count the number of lines of output, and the total number of characters in a document gives very little idea of the size
: a single page of graphics could be as long as 100K bytes, while a text file of the same length would be 50 to 100 pages.As there is no facility to specify the desired printer within the printer protocol, each user's current selection is stored in the active user table.  This can have three values
: output can be directed to a particular printer, or the system can be left to select a printer automatically.  The system manager can define the characteristics of the 'automatic' printer
: either one printer is specified as the only default printer (where the second printer is not suitable for normal text output), or an order of preference is specified, so that a document will be printed on the first choice printer if it is free and the user is allowed to use it, or on the second choice if this becomes available sooner.There are two ways that the user can select a printer
: by fileserver command, or by use of the status broadcast protocol.  The fileserver command is primarily for use with the PRINTOUT command; when using the normal printer protocol, it is necessary to ensure that the character stream is sent to the right station (ie. to the server), and this can most conveniently be set by use of the program which broadcasts the printer name and selects whichever station responds first.The server's implementation of the status protocol has to recognise four possible names
: the two printer names, 'AUTO', and 'PRINT'.  The first three update the user's current printer selection, and return the status of the newly selected printer, while 'PRINT' is arranged to return the status of whichever printer is already selected
: this is to retain compatibility with clients that poll the printer status before attempting to use it.|gprinter2